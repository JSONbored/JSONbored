name: WakaTime Custom

on:
  workflow_dispatch:
  schedule:
    # Runs every day at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  update-readme:
    name: Update README with WakaTime stats
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and format WakaTime stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          # Fetch stats for last 7 days using WakaTime API
          RESPONSE=$(curl -s -u "${WAKATIME_API_KEY}:" \
            "https://wakatime.com/api/v1/users/current/stats/last_7_days" 2>/dev/null || echo '{"error": "API call failed"}')
          
          # Save response to file for Python script
          echo "$RESPONSE" > response.json
          
          # Generate formatted stats
          python3 << 'PYTHON_SCRIPT'
          import json
          
          try:
              with open('response.json', 'r') as f:
                  data = json.load(f)
              
              stats_lines = []
              
              # Check for data in response
              if 'data' in data and 'languages' in data['data']:
                  languages = data['data']['languages']
                  
                  if languages and len(languages) > 0:
                      # Calculate total time
                      total_seconds = sum(lang.get('total_seconds', 0) for lang in languages)
                      
                      if total_seconds > 0:
                          # Sort by time (descending)
                          languages_sorted = sorted(languages, key=lambda x: x.get('total_seconds', 0), reverse=True)
                          
                          for lang in languages_sorted[:5]:  # Top 5 languages
                              name = lang.get('name', 'Unknown')
                              seconds = lang.get('total_seconds', 0)
                              hours = seconds // 3600
                              minutes = (seconds % 3600) // 60
                              percentage = (seconds / total_seconds * 100) if total_seconds > 0 else 0
                              
                              # Create progress bar (20 characters)
                              filled = int(percentage / 5)
                              bar = '█' * filled + '░' * (20 - filled)
                              
                              stats_lines.append(f"{name:<12} {hours:>2} hrs {minutes:>2} mins   {bar}   {percentage:>5.2f} %")
              
              if not stats_lines:
                  # Check if there's an error or no data
                  if 'error' in data:
                      stats_lines = [f"<!-- WakaTime API error: {data.get('error', 'Unknown error')} -->"]
                  elif 'message' in data:
                      stats_lines = [f"<!-- WakaTime: {data.get('message', 'No data available')} -->"]
                  else:
                      stats_lines = ["<!-- WakaTime stats will appear here once you have coding activity -->"]
              
              # Write stats to file
              with open('wakatime_stats.txt', 'w') as f:
                  f.write('\n'.join(stats_lines))
              
              print('\n'.join(stats_lines))
              
          except Exception as e:
              error_msg = f"<!-- WakaTime stats unavailable: {str(e)} -->"
              with open('wakatime_stats.txt', 'w') as f:
                  f.write(error_msg)
              print(error_msg)
          PYTHON_SCRIPT

      - name: Update README
        run: |
          python3 << 'EOF'
          import re
          
          readme_path = 'README.md'
          
          with open(readme_path, 'r') as f:
              content = f.read()
          
          start_marker = '<!--START_SECTION:waka-->'
          end_marker = '<!--END_SECTION:waka-->'
          
          with open('wakatime_stats.txt', 'r') as f:
              stats_text = f.read()
          
          pattern = f'{re.escape(start_marker)}.*?{re.escape(end_marker)}'
          replacement = f'{start_marker}\n\n{stats_text}\n\n{end_marker}'
          
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          with open(readme_path, 'w') as f:
              f.write(new_content)
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update wakatime stats"
          git push
